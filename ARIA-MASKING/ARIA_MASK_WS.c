/*
    This file is part of the ChipWhisperer Example Targets
    Copyright (C) 2012-2017 NewAE Technology Inc.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include "hal.h"
#include <stdint.h>
#include <stdlib.h>

#include "simpleserial.h"

uint8_t get_key(uint8_t* k, uint8_t len)
{
	// Load key here
	return 0x00;
}


typedef unsigned char u8;
// Encryption Key 선언
u8 ek1[16], ek2[16], ek3[16], ek4[16], ek5[16], ek6[16], ek7[16], ek8[16], ek9[16], ek10[16], ek11[16], ek12[16], ek13[16], ek14[16], ek15[16], ek16[16], ek17[16];
u8 SBOX1[256] = {   // Sbox1
  0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76,
  0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0,
  0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15,
  0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75,
  0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84,
  0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf,
  0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8,
  0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2,
  0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73,
  0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb,
  0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79,
  0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08,
  0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a,
  0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e,
  0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf,
  0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16 };
u8 SBOX2[256] = {   // Sbox2
  0xe2, 0x4e, 0x54, 0xfc, 0x94, 0xc2, 0x4a, 0xcc, 0x62, 0x0d, 0x6a, 0x46, 0x3c, 0x4d, 0x8b, 0xd1,
  0x5e, 0xfa, 0x64, 0xcb, 0xb4, 0x97, 0xbe, 0x2b, 0xbc, 0x77, 0x2e, 0x03, 0xd3, 0x19, 0x59, 0xc1,
  0x1d, 0x06, 0x41, 0x6b, 0x55, 0xf0, 0x99, 0x69, 0xea, 0x9c, 0x18, 0xae, 0x63, 0xdf, 0xe7, 0xbb,
  0x00, 0x73, 0x66, 0xfb, 0x96, 0x4c, 0x85, 0xe4, 0x3a, 0x09, 0x45, 0xaa, 0x0f, 0xee, 0x10, 0xeb,
  0x2d, 0x7f, 0xf4, 0x29, 0xac, 0xcf, 0xad, 0x91, 0x8d, 0x78, 0xc8, 0x95, 0xf9, 0x2f, 0xce, 0xcd,
  0x08, 0x7a, 0x88, 0x38, 0x5c, 0x83, 0x2a, 0x28, 0x47, 0xdb, 0xb8, 0xc7, 0x93, 0xa4, 0x12, 0x53,
  0xff, 0x87, 0x0e, 0x31, 0x36, 0x21, 0x58, 0x48, 0x01, 0x8e, 0x37, 0x74, 0x32, 0xca, 0xe9, 0xb1,
  0xb7, 0xab, 0x0c, 0xd7, 0xc4, 0x56, 0x42, 0x26, 0x07, 0x98, 0x60, 0xd9, 0xb6, 0xb9, 0x11, 0x40,
  0xec, 0x20, 0x8c, 0xbd, 0xa0, 0xc9, 0x84, 0x04, 0x49, 0x23, 0xf1, 0x4f, 0x50, 0x1f, 0x13, 0xdc,
  0xd8, 0xc0, 0x9e, 0x57, 0xe3, 0xc3, 0x7b, 0x65, 0x3b, 0x02, 0x8f, 0x3e, 0xe8, 0x25, 0x92, 0xe5,
  0x15, 0xdd, 0xfd, 0x17, 0xa9, 0xbf, 0xd4, 0x9a, 0x7e, 0xc5, 0x39, 0x67, 0xfe, 0x76, 0x9d, 0x43,
  0xa7, 0xe1, 0xd0, 0xf5, 0x68, 0xf2, 0x1b, 0x34, 0x70, 0x05, 0xa3, 0x8a, 0xd5, 0x79, 0x86, 0xa8,
  0x30, 0xc6, 0x51, 0x4b, 0x1e, 0xa6, 0x27, 0xf6, 0x35, 0xd2, 0x6e, 0x24, 0x16, 0x82, 0x5f, 0xda,
  0xe6, 0x75, 0xa2, 0xef, 0x2c, 0xb2, 0x1c, 0x9f, 0x5d, 0x6f, 0x80, 0x0a, 0x72, 0x44, 0x9b, 0x6c,
  0x90, 0x0b, 0x5b, 0x33, 0x7d, 0x5a, 0x52, 0xf3, 0x61, 0xa1, 0xf7, 0xb0, 0xd6, 0x3f, 0x7c, 0x6d,
  0xed, 0x14, 0xe0, 0xa5, 0x3d, 0x22, 0xb3, 0xf8, 0x89, 0xde, 0x71, 0x1a, 0xaf, 0xba, 0xb5, 0x81 };
u8 SBOX3[256] = {   // 역치환 Sbox1
  0x52, 0x09, 0x6a, 0xd5, 0x30, 0x36, 0xa5, 0x38, 0xbf, 0x40, 0xa3, 0x9e, 0x81, 0xf3, 0xd7, 0xfb,
  0x7c, 0xe3, 0x39, 0x82, 0x9b, 0x2f, 0xff, 0x87, 0x34, 0x8e, 0x43, 0x44, 0xc4, 0xde, 0xe9, 0xcb,
  0x54, 0x7b, 0x94, 0x32, 0xa6, 0xc2, 0x23, 0x3d, 0xee, 0x4c, 0x95, 0x0b, 0x42, 0xfa, 0xc3, 0x4e,
  0x08, 0x2e, 0xa1, 0x66, 0x28, 0xd9, 0x24, 0xb2, 0x76, 0x5b, 0xa2, 0x49, 0x6d, 0x8b, 0xd1, 0x25,
  0x72, 0xf8, 0xf6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xd4, 0xa4, 0x5c, 0xcc, 0x5d, 0x65, 0xb6, 0x92,
  0x6c, 0x70, 0x48, 0x50, 0xfd, 0xed, 0xb9, 0xda, 0x5e, 0x15, 0x46, 0x57, 0xa7, 0x8d, 0x9d, 0x84,
  0x90, 0xd8, 0xab, 0x00, 0x8c, 0xbc, 0xd3, 0x0a, 0xf7, 0xe4, 0x58, 0x05, 0xb8, 0xb3, 0x45, 0x06,
  0xd0, 0x2c, 0x1e, 0x8f, 0xca, 0x3f, 0x0f, 0x02, 0xc1, 0xaf, 0xbd, 0x03, 0x01, 0x13, 0x8a, 0x6b,
  0x3a, 0x91, 0x11, 0x41, 0x4f, 0x67, 0xdc, 0xea, 0x97, 0xf2, 0xcf, 0xce, 0xf0, 0xb4, 0xe6, 0x73,
  0x96, 0xac, 0x74, 0x22, 0xe7, 0xad, 0x35, 0x85, 0xe2, 0xf9, 0x37, 0xe8, 0x1c, 0x75, 0xdf, 0x6e,
  0x47, 0xf1, 0x1a, 0x71, 0x1d, 0x29, 0xc5, 0x89, 0x6f, 0xb7, 0x62, 0x0e, 0xaa, 0x18, 0xbe, 0x1b,
  0xfc, 0x56, 0x3e, 0x4b, 0xc6, 0xd2, 0x79, 0x20, 0x9a, 0xdb, 0xc0, 0xfe, 0x78, 0xcd, 0x5a, 0xf4,
  0x1f, 0xdd, 0xa8, 0x33, 0x88, 0x07, 0xc7, 0x31, 0xb1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xec, 0x5f,
  0x60, 0x51, 0x7f, 0xa9, 0x19, 0xb5, 0x4a, 0x0d, 0x2d, 0xe5, 0x7a, 0x9f, 0x93, 0xc9, 0x9c, 0xef,
  0xa0, 0xe0, 0x3b, 0x4d, 0xae, 0x2a, 0xf5, 0xb0, 0xc8, 0xeb, 0xbb, 0x3c, 0x83, 0x53, 0x99, 0x61,
  0x17, 0x2b, 0x04, 0x7e, 0xba, 0x77, 0xd6, 0x26, 0xe1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0c, 0x7d };
u8 SBOX4[256] = {   // 역치환 Sbox2
  0x30, 0x68, 0x99, 0x1b, 0x87, 0xb9, 0x21, 0x78, 0x50, 0x39, 0xdb, 0xe1, 0x72, 0x09, 0x62, 0x3c,
  0x3e, 0x7e, 0x5e, 0x8e, 0xf1, 0xa0, 0xcc, 0xa3, 0x2a, 0x1d, 0xfb, 0xb6, 0xd6, 0x20, 0xc4, 0x8d,
  0x81, 0x65, 0xf5, 0x89, 0xcb, 0x9d, 0x77, 0xc6, 0x57, 0x43, 0x56, 0x17, 0xd4, 0x40, 0x1a, 0x4d,
  0xc0, 0x63, 0x6c, 0xe3, 0xb7, 0xc8, 0x64, 0x6a, 0x53, 0xaa, 0x38, 0x98, 0x0c, 0xf4, 0x9b, 0xed,
  0x7f, 0x22, 0x76, 0xaf, 0xdd, 0x3a, 0x0b, 0x58, 0x67, 0x88, 0x06, 0xc3, 0x35, 0x0d, 0x01, 0x8b,
  0x8c, 0xc2, 0xe6, 0x5f, 0x02, 0x24, 0x75, 0x93, 0x66, 0x1e, 0xe5, 0xe2, 0x54, 0xd8, 0x10, 0xce,
  0x7a, 0xe8, 0x08, 0x2c, 0x12, 0x97, 0x32, 0xab, 0xb4, 0x27, 0x0a, 0x23, 0xdf, 0xef, 0xca, 0xd9,
  0xb8, 0xfa, 0xdc, 0x31, 0x6b, 0xd1, 0xad, 0x19, 0x49, 0xbd, 0x51, 0x96, 0xee, 0xe4, 0xa8, 0x41,
  0xda, 0xff, 0xcd, 0x55, 0x86, 0x36, 0xbe, 0x61, 0x52, 0xf8, 0xbb, 0x0e, 0x82, 0x48, 0x69, 0x9a,
  0xe0, 0x47, 0x9e, 0x5c, 0x04, 0x4b, 0x34, 0x15, 0x79, 0x26, 0xa7, 0xde, 0x29, 0xae, 0x92, 0xd7,
  0x84, 0xe9, 0xd2, 0xba, 0x5d, 0xf3, 0xc5, 0xb0, 0xbf, 0xa4, 0x3b, 0x71, 0x44, 0x46, 0x2b, 0xfc,
  0xeb, 0x6f, 0xd5, 0xf6, 0x14, 0xfe, 0x7c, 0x70, 0x5a, 0x7d, 0xfd, 0x2f, 0x18, 0x83, 0x16, 0xa5,
  0x91, 0x1f, 0x05, 0x95, 0x74, 0xa9, 0xc1, 0x5b, 0x4a, 0x85, 0x6d, 0x13, 0x07, 0x4f, 0x4e, 0x45,
  0xb2, 0x0f, 0xc9, 0x1c, 0xa6, 0xbc, 0xec, 0x73, 0x90, 0x7b, 0xcf, 0x59, 0x8f, 0xa1, 0xf9, 0x2d,
  0xf2, 0xb1, 0x00, 0x94, 0x37, 0x9f, 0xd0, 0x2e, 0x9c, 0x6e, 0x28, 0x3f, 0x80, 0xf0, 0x3d, 0xd3,
  0x25, 0x8a, 0xb5, 0xe7, 0x42, 0xb3, 0xc7, 0xea, 0xf7, 0x4c, 0x11, 0x33, 0x03, 0xa2, 0xac, 0x60 };
u8 MSBOX1[256];     // Masking Sbox1
u8 MSBOX2[256];     // Masking Sbox2
u8 MSBOX3[256];     // 역치환 Masking Sbox1
u8 MSBOX4[256];     // 역치환 Masking Sbox2

// Diffusion Layer 
void difflayer(u8 *out) {
   u8 temp[16]; 
 
   temp[ 0] = out[ 3] ^ out[ 4] ^ out[ 6] ^ out[ 8] ^ out[ 9] ^ out[13] ^ out[14];
   temp[ 1] = out[ 2] ^ out[ 5] ^ out[ 7] ^ out[ 8] ^ out[ 9] ^ out[12] ^ out[15];
   temp[ 2] = out[ 1] ^ out[ 4] ^ out[ 6] ^ out[10] ^ out[11] ^ out[12] ^ out[15];
   temp[ 3] = out[ 0] ^ out[ 5] ^ out[ 7] ^ out[10] ^ out[11] ^ out[13] ^ out[14];

   temp[ 4] = out[ 0] ^ out[ 2] ^ out[ 5] ^ out[ 8] ^ out[11] ^ out[14] ^ out[15];
   temp[ 5] = out[ 1] ^ out[ 3] ^ out[ 4] ^ out[ 9] ^ out[10] ^ out[14] ^ out[15];
   temp[ 6] = out[ 0] ^ out[ 2] ^ out[ 7] ^ out[ 9] ^ out[10] ^ out[12] ^ out[13];
   temp[ 7] = out[ 1] ^ out[ 3] ^ out[ 6] ^ out[ 8] ^ out[11] ^ out[12] ^ out[13];

   temp[ 8] = out[ 0] ^ out[ 1] ^ out[ 4] ^ out[ 7] ^ out[10] ^ out[13] ^ out[15];
   temp[ 9] = out[ 0] ^ out[ 1] ^ out[ 5] ^ out[ 6] ^ out[11] ^ out[12] ^ out[14];
   temp[10] = out[ 2] ^ out[ 3] ^ out[ 5] ^ out[ 6] ^ out[ 8] ^ out[13] ^ out[15];
   temp[11] = out[ 2] ^ out[ 3] ^ out[ 4] ^ out[ 7] ^ out[ 9] ^ out[12] ^ out[14];

   temp[12] = out[ 1] ^ out[ 2] ^ out[ 6] ^ out[ 7] ^ out[ 9] ^ out[11] ^ out[12];
   temp[13] = out[ 0] ^ out[ 3] ^ out[ 6] ^ out[ 7] ^ out[ 8] ^ out[10] ^ out[13];
   temp[14] = out[ 0] ^ out[ 3] ^ out[ 4] ^ out[ 5] ^ out[ 9] ^ out[11] ^ out[14];
   temp[15] = out[ 1] ^ out[ 2] ^ out[ 4] ^ out[ 5] ^ out[ 8] ^ out[10] ^ out[15];

   out[ 0] = temp[ 0]; out[ 1] = temp[ 1]; out[ 2] = temp[ 2]; out[ 3] = temp[ 3];
   out[ 4] = temp[ 4]; out[ 5] = temp[ 5]; out[ 6] = temp[ 6]; out[ 7] = temp[ 7];
   out[ 8] = temp[ 8]; out[ 9] = temp[ 9]; out[10] = temp[10]; out[11] = temp[11];
   out[12] = temp[12]; out[13] = temp[13]; out[14] = temp[14]; out[15] = temp[15];
}
// Encryption ODD
void ENC_ODD(u8* in, u8* K, u8* out) {
   out[ 0] = MSBOX1[in[ 0] ^ K[ 0]]; out[ 1] = MSBOX2[in[ 1] ^ K[ 1]]; 
   out[ 2] = MSBOX3[in[ 2] ^ K[ 2]]; out[ 3] = MSBOX4[in[ 3] ^ K[ 3]];
   out[ 4] = MSBOX1[in[ 4] ^ K[ 4]]; out[ 5] = MSBOX2[in[ 5] ^ K[ 5]]; 
   out[ 6] = MSBOX3[in[ 6] ^ K[ 6]]; out[ 7] = MSBOX4[in[ 7] ^ K[ 7]];
   out[ 8] = MSBOX1[in[ 8] ^ K[ 8]]; out[ 9] = MSBOX2[in[ 9] ^ K[ 9]]; 
   out[10] = MSBOX3[in[10] ^ K[10]]; out[11] = MSBOX4[in[11] ^ K[11]];
   out[12] = MSBOX1[in[12] ^ K[12]]; out[13] = MSBOX2[in[13] ^ K[13]]; 
   out[14] = MSBOX3[in[14] ^ K[14]]; out[15] = MSBOX4[in[15] ^ K[15]];
   difflayer(out);
}
// Encryption EVEN in : 중간값 out, K : RoundKey, out : PT
void ENC_EVEN(u8* in, u8* K, u8* out) {
   out[ 0] = MSBOX3[in[ 0] ^ K[ 0]]; out[ 1] = MSBOX4[in[ 1] ^ K[ 1]]; 
   out[ 2] = MSBOX1[in[ 2] ^ K[ 2]]; out[ 3] = MSBOX2[in[ 3] ^ K[ 3]];
   out[ 4] = MSBOX3[in[ 4] ^ K[ 4]]; out[ 5] = MSBOX4[in[ 5] ^ K[ 5]]; 
   out[ 6] = MSBOX1[in[ 6] ^ K[ 6]]; out[ 7] = MSBOX2[in[ 7] ^ K[ 7]];
   out[ 8] = MSBOX3[in[ 8] ^ K[ 8]]; out[ 9] = MSBOX4[in[ 9] ^ K[ 9]]; 
   out[10] = MSBOX1[in[10] ^ K[10]]; out[11] = MSBOX2[in[11] ^ K[11]];
   out[12] = MSBOX3[in[12] ^ K[12]]; out[13] = MSBOX4[in[13] ^ K[13]]; 
   out[14] = MSBOX1[in[14] ^ K[14]]; out[15] = MSBOX2[in[15] ^ K[15]];
   difflayer(out);
}
// Encryption FINAL in : 중간값, K1 K2 : 라운드키, out : 결과값
void ENC_FINAL(u8* in, u8* K1, u8* K2, u8* out) {
   out[ 0] = MSBOX3[in[ 0] ^ K1[ 0]] ^ K2[ 0]; out[ 1] = MSBOX4[in[ 1] ^ K1[ 1]] ^ K2[ 1]; 
   out[ 2] = MSBOX1[in[ 2] ^ K1[ 2]] ^ K2[ 2]; out[ 3] = MSBOX2[in[ 3] ^ K1[ 3]] ^ K2[ 3];
   out[ 4] = MSBOX3[in[ 4] ^ K1[ 4]] ^ K2[ 4]; out[ 5] = MSBOX4[in[ 5] ^ K1[ 5]] ^ K2[ 5]; 
   out[ 6] = MSBOX1[in[ 6] ^ K1[ 6]] ^ K2[ 6]; out[ 7] = MSBOX2[in[ 7] ^ K1[ 7]] ^ K2[ 7];
   out[ 8] = MSBOX3[in[ 8] ^ K1[ 8]] ^ K2[ 8]; out[ 9] = MSBOX4[in[ 9] ^ K1[ 9]] ^ K2[ 9]; 
   out[10] = MSBOX1[in[10] ^ K1[10]] ^ K2[10]; out[11] = MSBOX2[in[11] ^ K1[11]] ^ K2[11];
   out[12] = MSBOX3[in[12] ^ K1[12]] ^ K2[12]; out[13] = MSBOX4[in[13] ^ K1[13]] ^ K2[13]; 
   out[14] = MSBOX1[in[14] ^ K1[14]]; out[15] = MSBOX2[in[15] ^ K1[15]] ^ K2[15];
}
// ENC_RoundKey Generation
void ENC_RoundKey(u8 *W0, u8 *W1, u8 *W2, u8 *W3, u8 M3) {
   //ek1
   ek1[ 0] = ((W1[13] << 5) | (W1[14] >> 3)) ^ W0[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 1] = ((W1[14] << 5) | (W1[15] >> 3)) ^ W0[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 2] = ((W1[15] << 5) | (W1[ 0] >> 3)) ^ W0[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 3] = ((W1[ 0] << 5) | (W1[ 1] >> 3)) ^ W0[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 4] = ((W1[ 1] << 5) | (W1[ 2] >> 3)) ^ W0[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 5] = ((W1[ 2] << 5) | (W1[ 3] >> 3)) ^ W0[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 6] = ((W1[ 3] << 5) | (W1[ 4] >> 3)) ^ W0[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 7] = ((W1[ 4] << 5) | (W1[ 5] >> 3)) ^ W0[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 8] = ((W1[ 5] << 5) | (W1[ 6] >> 3)) ^ W0[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek1[ 9] = ((W1[ 6] << 5) | (W1[ 7] >> 3)) ^ W0[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek1[10] = ((W1[ 7] << 5) | (W1[ 8] >> 3)) ^ W0[10] ^ ((M3 << 5) | (M3 >> 3));
   ek1[11] = ((W1[ 8] << 5) | (W1[ 9] >> 3)) ^ W0[11] ^ ((M3 << 5) | (M3 >> 3));
   ek1[12] = ((W1[ 9] << 5) | (W1[10] >> 3)) ^ W0[12] ^ ((M3 << 5) | (M3 >> 3));
   ek1[13] = ((W1[10] << 5) | (W1[11] >> 3)) ^ W0[13] ^ ((M3 << 5) | (M3 >> 3));
   ek1[14] = ((W1[11] << 5) | (W1[12] >> 3)) ^ W0[14] ^ ((M3 << 5) | (M3 >> 3));
   ek1[15] = ((W1[12] << 5) | (W1[13] >> 3)) ^ W0[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek2
   ek2[ 0] = ((W2[13] << 5) | (W2[14] >> 3)) ^ W1[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 1] = ((W2[14] << 5) | (W2[15] >> 3)) ^ W1[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 2] = ((W2[15] << 5) | (W2[ 0] >> 3)) ^ W1[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 3] = ((W2[ 0] << 5) | (W2[ 1] >> 3)) ^ W1[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 4] = ((W2[ 1] << 5) | (W2[ 2] >> 3)) ^ W1[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 5] = ((W2[ 2] << 5) | (W2[ 3] >> 3)) ^ W1[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 6] = ((W2[ 3] << 5) | (W2[ 4] >> 3)) ^ W1[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 7] = ((W2[ 4] << 5) | (W2[ 5] >> 3)) ^ W1[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 8] = ((W2[ 5] << 5) | (W2[ 6] >> 3)) ^ W1[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek2[ 9] = ((W2[ 6] << 5) | (W2[ 7] >> 3)) ^ W1[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek2[10] = ((W2[ 7] << 5) | (W2[ 8] >> 3)) ^ W1[10] ^ ((M3 << 5) | (M3 >> 3));
   ek2[11] = ((W2[ 8] << 5) | (W2[ 9] >> 3)) ^ W1[11] ^ ((M3 << 5) | (M3 >> 3));
   ek2[12] = ((W2[ 9] << 5) | (W2[10] >> 3)) ^ W1[12] ^ ((M3 << 5) | (M3 >> 3));
   ek2[13] = ((W2[10] << 5) | (W2[11] >> 3)) ^ W1[13] ^ ((M3 << 5) | (M3 >> 3));
   ek2[14] = ((W2[11] << 5) | (W2[12] >> 3)) ^ W1[14] ^ ((M3 << 5) | (M3 >> 3));
   ek2[15] = ((W2[12] << 5) | (W2[13] >> 3)) ^ W1[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek3
   ek3[ 0] = ((W3[13] << 5) | (W3[14] >> 3)) ^ W2[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 1] = ((W3[14] << 5) | (W3[15] >> 3)) ^ W2[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 2] = ((W3[15] << 5) | (W3[ 0] >> 3)) ^ W2[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 3] = ((W3[ 0] << 5) | (W3[ 1] >> 3)) ^ W2[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 4] = ((W3[ 1] << 5) | (W3[ 2] >> 3)) ^ W2[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 5] = ((W3[ 2] << 5) | (W3[ 3] >> 3)) ^ W2[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 6] = ((W3[ 3] << 5) | (W3[ 4] >> 3)) ^ W2[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 7] = ((W3[ 4] << 5) | (W3[ 5] >> 3)) ^ W2[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 8] = ((W3[ 5] << 5) | (W3[ 6] >> 3)) ^ W2[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek3[ 9] = ((W3[ 6] << 5) | (W3[ 7] >> 3)) ^ W2[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek3[10] = ((W3[ 7] << 5) | (W3[ 8] >> 3)) ^ W2[10] ^ ((M3 << 5) | (M3 >> 3));
   ek3[11] = ((W3[ 8] << 5) | (W3[ 9] >> 3)) ^ W2[11] ^ ((M3 << 5) | (M3 >> 3));
   ek3[12] = ((W3[ 9] << 5) | (W3[10] >> 3)) ^ W2[12] ^ ((M3 << 5) | (M3 >> 3));
   ek3[13] = ((W3[10] << 5) | (W3[11] >> 3)) ^ W2[13] ^ ((M3 << 5) | (M3 >> 3));
   ek3[14] = ((W3[11] << 5) | (W3[12] >> 3)) ^ W2[14] ^ ((M3 << 5) | (M3 >> 3));
   ek3[15] = ((W3[12] << 5) | (W3[13] >> 3)) ^ W2[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek4
   ek4[ 0] = ((W0[13] << 5) | (W0[14] >> 3)) ^ W3[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 1] = ((W0[14] << 5) | (W0[15] >> 3)) ^ W3[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 2] = ((W0[15] << 5) | (W0[ 0] >> 3)) ^ W3[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 3] = ((W0[ 0] << 5) | (W0[ 1] >> 3)) ^ W3[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 4] = ((W0[ 1] << 5) | (W0[ 2] >> 3)) ^ W3[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 5] = ((W0[ 2] << 5) | (W0[ 3] >> 3)) ^ W3[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 6] = ((W0[ 3] << 5) | (W0[ 4] >> 3)) ^ W3[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 7] = ((W0[ 4] << 5) | (W0[ 5] >> 3)) ^ W3[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 8] = ((W0[ 5] << 5) | (W0[ 6] >> 3)) ^ W3[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek4[ 9] = ((W0[ 6] << 5) | (W0[ 7] >> 3)) ^ W3[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek4[10] = ((W0[ 7] << 5) | (W0[ 8] >> 3)) ^ W3[10] ^ ((M3 << 5) | (M3 >> 3));
   ek4[11] = ((W0[ 8] << 5) | (W0[ 9] >> 3)) ^ W3[11] ^ ((M3 << 5) | (M3 >> 3));
   ek4[12] = ((W0[ 9] << 5) | (W0[10] >> 3)) ^ W3[12] ^ ((M3 << 5) | (M3 >> 3));
   ek4[13] = ((W0[10] << 5) | (W0[11] >> 3)) ^ W3[13] ^ ((M3 << 5) | (M3 >> 3));
   ek4[14] = ((W0[11] << 5) | (W0[12] >> 3)) ^ W3[14] ^ ((M3 << 5) | (M3 >> 3));
   ek4[15] = ((W0[12] << 5) | (W0[13] >> 3)) ^ W3[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek5
   ek5[ 0] = ((W1[12] << 1) | (W1[13] >> 7)) ^ W0[ 0] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 1] = ((W1[13] << 1) | (W1[14] >> 7)) ^ W0[ 1] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 2] = ((W1[14] << 1) | (W1[15] >> 7)) ^ W0[ 2] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 3] = ((W1[15] << 1) | (W1[ 0] >> 7)) ^ W0[ 3] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 4] = ((W1[ 0] << 1) | (W1[ 1] >> 7)) ^ W0[ 4] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 5] = ((W1[ 1] << 1) | (W1[ 2] >> 7)) ^ W0[ 5] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 6] = ((W1[ 2] << 1) | (W1[ 3] >> 7)) ^ W0[ 6] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 7] = ((W1[ 3] << 1) | (W1[ 4] >> 7)) ^ W0[ 7] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 8] = ((W1[ 4] << 1) | (W1[ 5] >> 7)) ^ W0[ 8] ^ ((M3 << 1) | (M3 >> 7));
   ek5[ 9] = ((W1[ 5] << 1) | (W1[ 6] >> 7)) ^ W0[ 9] ^ ((M3 << 1) | (M3 >> 7));
   ek5[10] = ((W1[ 6] << 1) | (W1[ 7] >> 7)) ^ W0[10] ^ ((M3 << 1) | (M3 >> 7));
   ek5[11] = ((W1[ 7] << 1) | (W1[ 8] >> 7)) ^ W0[11] ^ ((M3 << 1) | (M3 >> 7));
   ek5[12] = ((W1[ 8] << 1) | (W1[ 9] >> 7)) ^ W0[12] ^ ((M3 << 1) | (M3 >> 7));
   ek5[13] = ((W1[ 9] << 1) | (W1[10] >> 7)) ^ W0[13] ^ ((M3 << 1) | (M3 >> 7));
   ek5[14] = ((W1[10] << 1) | (W1[11] >> 7)) ^ W0[14] ^ ((M3 << 1) | (M3 >> 7));
   ek5[15] = ((W1[11] << 1) | (W1[12] >> 7)) ^ W0[15] ^ ((M3 << 1) | (M3 >> 7));
   //ek6
   ek6[ 0] = ((W2[12] << 1) | (W2[13] >> 7)) ^ W1[ 0] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 1] = ((W2[13] << 1) | (W2[14] >> 7)) ^ W1[ 1] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 2] = ((W2[14] << 1) | (W2[15] >> 7)) ^ W1[ 2] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 3] = ((W2[15] << 1) | (W2[ 0] >> 7)) ^ W1[ 3] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 4] = ((W2[ 0] << 1) | (W2[ 1] >> 7)) ^ W1[ 4] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 5] = ((W2[ 1] << 1) | (W2[ 2] >> 7)) ^ W1[ 5] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 6] = ((W2[ 2] << 1) | (W2[ 3] >> 7)) ^ W1[ 6] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 7] = ((W2[ 3] << 1) | (W2[ 4] >> 7)) ^ W1[ 7] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 8] = ((W2[ 4] << 1) | (W2[ 5] >> 7)) ^ W1[ 8] ^ ((M3 << 1) | (M3 >> 7));
   ek6[ 9] = ((W2[ 5] << 1) | (W2[ 6] >> 7)) ^ W1[ 9] ^ ((M3 << 1) | (M3 >> 7));
   ek6[10] = ((W2[ 6] << 1) | (W2[ 7] >> 7)) ^ W1[10] ^ ((M3 << 1) | (M3 >> 7));
   ek6[11] = ((W2[ 7] << 1) | (W2[ 8] >> 7)) ^ W1[11] ^ ((M3 << 1) | (M3 >> 7));
   ek6[12] = ((W2[ 8] << 1) | (W2[ 9] >> 7)) ^ W1[12] ^ ((M3 << 1) | (M3 >> 7));
   ek6[13] = ((W2[ 9] << 1) | (W2[10] >> 7)) ^ W1[13] ^ ((M3 << 1) | (M3 >> 7));
   ek6[14] = ((W2[10] << 1) | (W2[11] >> 7)) ^ W1[14] ^ ((M3 << 1) | (M3 >> 7));
   ek6[15] = ((W2[11] << 1) | (W2[12] >> 7)) ^ W1[15] ^ ((M3 << 1) | (M3 >> 7));
   //ek7
   ek7[ 0] = ((W3[12] << 1) | (W3[13] >> 7)) ^ W2[ 0] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 1] = ((W3[13] << 1) | (W3[14] >> 7)) ^ W2[ 1] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 2] = ((W3[14] << 1) | (W3[15] >> 7)) ^ W2[ 2] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 3] = ((W3[15] << 1) | (W3[ 0] >> 7)) ^ W2[ 3] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 4] = ((W3[ 0] << 1) | (W3[ 1] >> 7)) ^ W2[ 4] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 5] = ((W3[ 1] << 1) | (W3[ 2] >> 7)) ^ W2[ 5] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 6] = ((W3[ 2] << 1) | (W3[ 3] >> 7)) ^ W2[ 6] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 7] = ((W3[ 3] << 1) | (W3[ 4] >> 7)) ^ W2[ 7] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 8] = ((W3[ 4] << 1) | (W3[ 5] >> 7)) ^ W2[ 8] ^ ((M3 << 1) | (M3 >> 7));
   ek7[ 9] = ((W3[ 5] << 1) | (W3[ 6] >> 7)) ^ W2[ 9] ^ ((M3 << 1) | (M3 >> 7));
   ek7[10] = ((W3[ 6] << 1) | (W3[ 7] >> 7)) ^ W2[10] ^ ((M3 << 1) | (M3 >> 7));
   ek7[11] = ((W3[ 7] << 1) | (W3[ 8] >> 7)) ^ W2[11] ^ ((M3 << 1) | (M3 >> 7));
   ek7[12] = ((W3[ 8] << 1) | (W3[ 9] >> 7)) ^ W2[12] ^ ((M3 << 1) | (M3 >> 7));
   ek7[13] = ((W3[ 9] << 1) | (W3[10] >> 7)) ^ W2[13] ^ ((M3 << 1) | (M3 >> 7));
   ek7[14] = ((W3[10] << 1) | (W3[11] >> 7)) ^ W2[14] ^ ((M3 << 1) | (M3 >> 7));
   ek7[15] = ((W3[11] << 1) | (W3[12] >> 7)) ^ W2[15] ^ ((M3 << 1) | (M3 >> 7));
   //ek8
   ek8[ 0] = ((W0[12] << 1) | (W0[13] >> 7)) ^ W3[ 0] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 1] = ((W0[13] << 1) | (W0[14] >> 7)) ^ W3[ 1] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 2] = ((W0[14] << 1) | (W0[15] >> 7)) ^ W3[ 2] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 3] = ((W0[15] << 1) | (W0[ 0] >> 7)) ^ W3[ 3] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 4] = ((W0[ 0] << 1) | (W0[ 1] >> 7)) ^ W3[ 4] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 5] = ((W0[ 1] << 1) | (W0[ 2] >> 7)) ^ W3[ 5] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 6] = ((W0[ 2] << 1) | (W0[ 3] >> 7)) ^ W3[ 6] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 7] = ((W0[ 3] << 1) | (W0[ 4] >> 7)) ^ W3[ 7] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 8] = ((W0[ 4] << 1) | (W0[ 5] >> 7)) ^ W3[ 8] ^ ((M3 << 1) | (M3 >> 7));
   ek8[ 9] = ((W0[ 5] << 1) | (W0[ 6] >> 7)) ^ W3[ 9] ^ ((M3 << 1) | (M3 >> 7));
   ek8[10] = ((W0[ 6] << 1) | (W0[ 7] >> 7)) ^ W3[10] ^ ((M3 << 1) | (M3 >> 7));
   ek8[11] = ((W0[ 7] << 1) | (W0[ 8] >> 7)) ^ W3[11] ^ ((M3 << 1) | (M3 >> 7));
   ek8[12] = ((W0[ 8] << 1) | (W0[ 9] >> 7)) ^ W3[12] ^ ((M3 << 1) | (M3 >> 7));
   ek8[13] = ((W0[ 9] << 1) | (W0[10] >> 7)) ^ W3[13] ^ ((M3 << 1) | (M3 >> 7));
   ek8[14] = ((W0[10] << 1) | (W0[11] >> 7)) ^ W3[14] ^ ((M3 << 1) | (M3 >> 7));
   ek8[15] = ((W0[11] << 1) | (W0[12] >> 7)) ^ W3[15] ^ ((M3 << 1) | (M3 >> 7));
   //ek9
   ek9[ 0] = ((W1[ 7] << 5) | (W1[ 8] >> 3)) ^ W0[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 1] = ((W1[ 8] << 5) | (W1[ 9] >> 3)) ^ W0[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 2] = ((W1[ 9] << 5) | (W1[10] >> 3)) ^ W0[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 3] = ((W1[10] << 5) | (W1[11] >> 3)) ^ W0[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 4] = ((W1[11] << 5) | (W1[12] >> 3)) ^ W0[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 5] = ((W1[12] << 5) | (W1[13] >> 3)) ^ W0[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 6] = ((W1[13] << 5) | (W1[14] >> 3)) ^ W0[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 7] = ((W1[14] << 5) | (W1[15] >> 3)) ^ W0[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 8] = ((W1[15] << 5) | (W1[ 0] >> 3)) ^ W0[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek9[ 9] = ((W1[ 0] << 5) | (W1[ 1] >> 3)) ^ W0[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek9[10] = ((W1[ 1] << 5) | (W1[ 2] >> 3)) ^ W0[10] ^ ((M3 << 5) | (M3 >> 3));
   ek9[11] = ((W1[ 2] << 5) | (W1[ 3] >> 3)) ^ W0[11] ^ ((M3 << 5) | (M3 >> 3));
   ek9[12] = ((W1[ 3] << 5) | (W1[ 4] >> 3)) ^ W0[12] ^ ((M3 << 5) | (M3 >> 3));
   ek9[13] = ((W1[ 4] << 5) | (W1[ 5] >> 3)) ^ W0[13] ^ ((M3 << 5) | (M3 >> 3));
   ek9[14] = ((W1[ 5] << 5) | (W1[ 6] >> 3)) ^ W0[14] ^ ((M3 << 5) | (M3 >> 3));
   ek9[15] = ((W1[ 6] << 5) | (W1[ 7] >> 3)) ^ W0[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek10
   ek10[ 0] = ((W2[ 7] << 5) | (W2[ 8] >> 3)) ^ W1[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 1] = ((W2[ 8] << 5) | (W2[ 9] >> 3)) ^ W1[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 2] = ((W2[ 9] << 5) | (W2[10] >> 3)) ^ W1[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 3] = ((W2[10] << 5) | (W2[11] >> 3)) ^ W1[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 4] = ((W2[11] << 5) | (W2[12] >> 3)) ^ W1[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 5] = ((W2[12] << 5) | (W2[13] >> 3)) ^ W1[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 6] = ((W2[13] << 5) | (W2[14] >> 3)) ^ W1[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 7] = ((W2[14] << 5) | (W2[15] >> 3)) ^ W1[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 8] = ((W2[15] << 5) | (W2[ 0] >> 3)) ^ W1[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek10[ 9] = ((W2[ 0] << 5) | (W2[ 1] >> 3)) ^ W1[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek10[10] = ((W2[ 1] << 5) | (W2[ 2] >> 3)) ^ W1[10] ^ ((M3 << 5) | (M3 >> 3));
   ek10[11] = ((W2[ 2] << 5) | (W2[ 3] >> 3)) ^ W1[11] ^ ((M3 << 5) | (M3 >> 3));
   ek10[12] = ((W2[ 3] << 5) | (W2[ 4] >> 3)) ^ W1[12] ^ ((M3 << 5) | (M3 >> 3));
   ek10[13] = ((W2[ 4] << 5) | (W2[ 5] >> 3)) ^ W1[13] ^ ((M3 << 5) | (M3 >> 3));
   ek10[14] = ((W2[ 5] << 5) | (W2[ 6] >> 3)) ^ W1[14] ^ ((M3 << 5) | (M3 >> 3));
   ek10[15] = ((W2[ 6] << 5) | (W2[ 7] >> 3)) ^ W1[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek11
   ek11[ 0] = ((W3[ 7] << 5) | (W3[ 8] >> 3)) ^ W2[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 1] = ((W3[ 8] << 5) | (W3[ 9] >> 3)) ^ W2[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 2] = ((W3[ 9] << 5) | (W3[10] >> 3)) ^ W2[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 3] = ((W3[10] << 5) | (W3[11] >> 3)) ^ W2[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 4] = ((W3[11] << 5) | (W3[12] >> 3)) ^ W2[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 5] = ((W3[12] << 5) | (W3[13] >> 3)) ^ W2[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 6] = ((W3[13] << 5) | (W3[14] >> 3)) ^ W2[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 7] = ((W3[14] << 5) | (W3[15] >> 3)) ^ W2[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 8] = ((W3[15] << 5) | (W3[ 0] >> 3)) ^ W2[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek11[ 9] = ((W3[ 0] << 5) | (W3[ 1] >> 3)) ^ W2[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek11[10] = ((W3[ 1] << 5) | (W3[ 2] >> 3)) ^ W2[10] ^ ((M3 << 5) | (M3 >> 3));
   ek11[11] = ((W3[ 2] << 5) | (W3[ 3] >> 3)) ^ W2[11] ^ ((M3 << 5) | (M3 >> 3));
   ek11[12] = ((W3[ 3] << 5) | (W3[ 4] >> 3)) ^ W2[12] ^ ((M3 << 5) | (M3 >> 3));
   ek11[13] = ((W3[ 4] << 5) | (W3[ 5] >> 3)) ^ W2[13] ^ ((M3 << 5) | (M3 >> 3));
   ek11[14] = ((W3[ 5] << 5) | (W3[ 6] >> 3)) ^ W2[14] ^ ((M3 << 5) | (M3 >> 3));
   ek11[15] = ((W3[ 6] << 5) | (W3[ 7] >> 3)) ^ W2[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek12
   ek12[ 0] = ((W0[ 7] << 5) | (W0[ 8] >> 3)) ^ W3[ 0] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 1] = ((W0[ 8] << 5) | (W0[ 9] >> 3)) ^ W3[ 1] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 2] = ((W0[ 9] << 5) | (W0[10] >> 3)) ^ W3[ 2] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 3] = ((W0[10] << 5) | (W0[11] >> 3)) ^ W3[ 3] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 4] = ((W0[11] << 5) | (W0[12] >> 3)) ^ W3[ 4] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 5] = ((W0[12] << 5) | (W0[13] >> 3)) ^ W3[ 5] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 6] = ((W0[13] << 5) | (W0[14] >> 3)) ^ W3[ 6] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 7] = ((W0[14] << 5) | (W0[15] >> 3)) ^ W3[ 7] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 8] = ((W0[15] << 5) | (W0[ 0] >> 3)) ^ W3[ 8] ^ ((M3 << 5) | (M3 >> 3));
   ek12[ 9] = ((W0[ 0] << 5) | (W0[ 1] >> 3)) ^ W3[ 9] ^ ((M3 << 5) | (M3 >> 3));
   ek12[10] = ((W0[ 1] << 5) | (W0[ 2] >> 3)) ^ W3[10] ^ ((M3 << 5) | (M3 >> 3));
   ek12[11] = ((W0[ 2] << 5) | (W0[ 3] >> 3)) ^ W3[11] ^ ((M3 << 5) | (M3 >> 3));
   ek12[12] = ((W0[ 3] << 5) | (W0[ 4] >> 3)) ^ W3[12] ^ ((M3 << 5) | (M3 >> 3));
   ek12[13] = ((W0[ 4] << 5) | (W0[ 5] >> 3)) ^ W3[13] ^ ((M3 << 5) | (M3 >> 3));
   ek12[14] = ((W0[ 5] << 5) | (W0[ 6] >> 3)) ^ W3[14] ^ ((M3 << 5) | (M3 >> 3));
   ek12[15] = ((W0[ 6] << 5) | (W0[ 7] >> 3)) ^ W3[15] ^ ((M3 << 5) | (M3 >> 3));
   //ek13
   ek13[ 0] = ((W1[ 3] << 7) | (W1[ 4] >> 1)) ^ W0[ 0] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 1] = ((W1[ 4] << 7) | (W1[ 5] >> 1)) ^ W0[ 1] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 2] = ((W1[ 5] << 7) | (W1[ 6] >> 1)) ^ W0[ 2] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 3] = ((W1[ 6] << 7) | (W1[ 7] >> 1)) ^ W0[ 3] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 4] = ((W1[ 7] << 7) | (W1[ 8] >> 1)) ^ W0[ 4] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 5] = ((W1[ 8] << 7) | (W1[ 9] >> 1)) ^ W0[ 5] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 6] = ((W1[ 9] << 7) | (W1[10] >> 1)) ^ W0[ 6] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 7] = ((W1[10] << 7) | (W1[11] >> 1)) ^ W0[ 7] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 8] = ((W1[11] << 7) | (W1[12] >> 1)) ^ W0[ 8] ^ ((M3 << 7) | (M3 >> 1));
   ek13[ 9] = ((W1[12] << 7) | (W1[13] >> 1)) ^ W0[ 9] ^ ((M3 << 7) | (M3 >> 1));
   ek13[10] = ((W1[13] << 7) | (W1[14] >> 1)) ^ W0[10] ^ ((M3 << 7) | (M3 >> 1));
   ek13[11] = ((W1[14] << 7) | (W1[15] >> 1)) ^ W0[11] ^ ((M3 << 7) | (M3 >> 1));
   ek13[12] = ((W1[15] << 7) | (W1[ 0] >> 1)) ^ W0[12] ^ ((M3 << 7) | (M3 >> 1));
   ek13[13] = ((W1[ 0] << 7) | (W1[ 1] >> 1)) ^ W0[13] ^ ((M3 << 7) | (M3 >> 1));
   ek13[14] = ((W1[ 1] << 7) | (W1[ 2] >> 1)) ^ W0[14] ^ ((M3 << 7) | (M3 >> 1));
   ek13[15] = ((W1[ 2] << 7) | (W1[ 3] >> 1)) ^ W0[15] ^ ((M3 << 7) | (M3 >> 1));
   //ek14
   ek14[ 0] = ((W2[ 3] << 7) | (W2[ 4] >> 1)) ^ W1[ 0] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 1] = ((W2[ 4] << 7) | (W2[ 5] >> 1)) ^ W1[ 1] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 2] = ((W2[ 5] << 7) | (W2[ 6] >> 1)) ^ W1[ 2] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 3] = ((W2[ 6] << 7) | (W2[ 7] >> 1)) ^ W1[ 3] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 4] = ((W2[ 7] << 7) | (W2[ 8] >> 1)) ^ W1[ 4] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 5] = ((W2[ 8] << 7) | (W2[ 9] >> 1)) ^ W1[ 5] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 6] = ((W2[ 9] << 7) | (W2[10] >> 1)) ^ W1[ 6] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 7] = ((W2[10] << 7) | (W2[11] >> 1)) ^ W1[ 7] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 8] = ((W2[11] << 7) | (W2[12] >> 1)) ^ W1[ 8] ^ ((M3 << 7) | (M3 >> 1));
   ek14[ 9] = ((W2[12] << 7) | (W2[13] >> 1)) ^ W1[ 9] ^ ((M3 << 7) | (M3 >> 1));
   ek14[10] = ((W2[13] << 7) | (W2[14] >> 1)) ^ W1[10] ^ ((M3 << 7) | (M3 >> 1));
   ek14[11] = ((W2[14] << 7) | (W2[15] >> 1)) ^ W1[11] ^ ((M3 << 7) | (M3 >> 1));
   ek14[12] = ((W2[15] << 7) | (W2[ 0] >> 1)) ^ W1[12] ^ ((M3 << 7) | (M3 >> 1));
   ek14[13] = ((W2[ 0] << 7) | (W2[ 1] >> 1)) ^ W1[13] ^ ((M3 << 7) | (M3 >> 1));
   ek14[14] = ((W2[ 1] << 7) | (W2[ 2] >> 1)) ^ W1[14] ^ ((M3 << 7) | (M3 >> 1));
   ek14[15] = ((W2[ 2] << 7) | (W2[ 3] >> 1)) ^ W1[15] ^ ((M3 << 7) | (M3 >> 1));
   //ek15
   ek15[ 0] = ((W3[ 3] << 7) | (W3[ 4] >> 1)) ^ W2[ 0] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 1] = ((W3[ 4] << 7) | (W3[ 5] >> 1)) ^ W2[ 1] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 2] = ((W3[ 5] << 7) | (W3[ 6] >> 1)) ^ W2[ 2] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 3] = ((W3[ 6] << 7) | (W3[ 7] >> 1)) ^ W2[ 3] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 4] = ((W3[ 7] << 7) | (W3[ 8] >> 1)) ^ W2[ 4] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 5] = ((W3[ 8] << 7) | (W3[ 9] >> 1)) ^ W2[ 5] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 6] = ((W3[ 9] << 7) | (W3[10] >> 1)) ^ W2[ 6] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 7] = ((W3[10] << 7) | (W3[11] >> 1)) ^ W2[ 7] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 8] = ((W3[11] << 7) | (W3[12] >> 1)) ^ W2[ 8] ^ ((M3 << 7) | (M3 >> 1));
   ek15[ 9] = ((W3[12] << 7) | (W3[13] >> 1)) ^ W2[ 9] ^ ((M3 << 7) | (M3 >> 1));
   ek15[10] = ((W3[13] << 7) | (W3[14] >> 1)) ^ W2[10] ^ ((M3 << 7) | (M3 >> 1));
   ek15[11] = ((W3[14] << 7) | (W3[15] >> 1)) ^ W2[11] ^ ((M3 << 7) | (M3 >> 1));
   ek15[12] = ((W3[15] << 7) | (W3[ 0] >> 1)) ^ W2[12] ^ ((M3 << 7) | (M3 >> 1));
   ek15[13] = ((W3[ 0] << 7) | (W3[ 1] >> 1)) ^ W2[13] ^ ((M3 << 7) | (M3 >> 1));
   ek15[14] = ((W3[ 1] << 7) | (W3[ 2] >> 1)) ^ W2[14] ^ ((M3 << 7) | (M3 >> 1));
   ek15[15] = ((W3[ 2] << 7) | (W3[ 3] >> 1)) ^ W2[15] ^ ((M3 << 7) | (M3 >> 1));
   //ek16
   ek16[ 0] = ((W0[ 3] << 7) | (W0[ 4] >> 1)) ^ W3[ 0] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 1] = ((W0[ 4] << 7) | (W0[ 5] >> 1)) ^ W3[ 1] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 2] = ((W0[ 5] << 7) | (W0[ 6] >> 1)) ^ W3[ 2] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 3] = ((W0[ 6] << 7) | (W0[ 7] >> 1)) ^ W3[ 3] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 4] = ((W0[ 7] << 7) | (W0[ 8] >> 1)) ^ W3[ 4] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 5] = ((W0[ 8] << 7) | (W0[ 9] >> 1)) ^ W3[ 5] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 6] = ((W0[ 9] << 7) | (W0[10] >> 1)) ^ W3[ 6] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 7] = ((W0[10] << 7) | (W0[11] >> 1)) ^ W3[ 7] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 8] = ((W0[11] << 7) | (W0[12] >> 1)) ^ W3[ 8] ^ ((M3 << 7) | (M3 >> 1));
   ek16[ 9] = ((W0[12] << 7) | (W0[13] >> 1)) ^ W3[ 9] ^ ((M3 << 7) | (M3 >> 1));
   ek16[10] = ((W0[13] << 7) | (W0[14] >> 1)) ^ W3[10] ^ ((M3 << 7) | (M3 >> 1));
   ek16[11] = ((W0[14] << 7) | (W0[15] >> 1)) ^ W3[11] ^ ((M3 << 7) | (M3 >> 1));
   ek16[12] = ((W0[15] << 7) | (W0[ 0] >> 1)) ^ W3[12] ^ ((M3 << 7) | (M3 >> 1));
   ek16[13] = ((W0[ 0] << 7) | (W0[ 1] >> 1)) ^ W3[13] ^ ((M3 << 7) | (M3 >> 1));
   ek16[14] = ((W0[ 1] << 7) | (W0[ 2] >> 1)) ^ W3[14] ^ ((M3 << 7) | (M3 >> 1));
   ek16[15] = ((W0[ 2] << 7) | (W0[ 3] >> 1)) ^ W3[15] ^ ((M3 << 7) | (M3 >> 1));
   //ek17
   ek17[ 0] = ((W1[ 2] << 3) | (W1[ 3] >> 5)) ^ W0[ 0] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 2] = ((W1[ 4] << 3) | (W1[ 5] >> 5)) ^ W0[ 2] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 1] = ((W1[ 3] << 3) | (W1[ 4] >> 5)) ^ W0[ 1] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 4] = ((W1[ 6] << 3) | (W1[ 7] >> 5)) ^ W0[ 4] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 3] = ((W1[ 5] << 3) | (W1[ 6] >> 5)) ^ W0[ 3] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 5] = ((W1[ 7] << 3) | (W1[ 8] >> 5)) ^ W0[ 5] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 6] = ((W1[ 8] << 3) | (W1[ 9] >> 5)) ^ W0[ 6] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 7] = ((W1[ 9] << 3) | (W1[10] >> 5)) ^ W0[ 7] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 8] = ((W1[10] << 3) | (W1[11] >> 5)) ^ W0[ 8] ^ ((M3 << 3) | (M3 >> 5));
   ek17[ 9] = ((W1[11] << 3) | (W1[12] >> 5)) ^ W0[ 9] ^ ((M3 << 3) | (M3 >> 5));
   ek17[10] = ((W1[12] << 3) | (W1[13] >> 5)) ^ W0[10] ^ ((M3 << 3) | (M3 >> 5));
   ek17[11] = ((W1[13] << 3) | (W1[14] >> 5)) ^ W0[11] ^ ((M3 << 3) | (M3 >> 5));
   ek17[12] = ((W1[14] << 3) | (W1[15] >> 5)) ^ W0[12] ^ ((M3 << 3) | (M3 >> 5));
   ek17[13] = ((W1[15] << 3) | (W1[ 0] >> 5)) ^ W0[13] ^ ((M3 << 3) | (M3 >> 5));
   ek17[14] = ((W1[ 0] << 3) | (W1[ 1] >> 5)) ^ W0[14] ^ ((M3 << 3) | (M3 >> 5));
   ek17[15] = ((W1[ 1] << 3) | (W1[ 2] >> 5)) ^ W0[15] ^ ((M3 << 3) | (M3 >> 5));
}
//키 확장 초기화 및 라운드키 호출
void Key_Expansion(u8* MK, u8 M1, u8 M2, u8 M3) {

   u8    C1[16] = { 0x51, 0x7c, 0xc1, 0xb7, 0x27, 0x22, 0x0a, 0x94, 0xfe, 0x13, 0xab, 0xe8, 0xfa, 0x9a, 0x6e, 0xe0 };
   u8    C2[16] = { 0x6d, 0xb1, 0x4a, 0xcc, 0x9e, 0x21, 0xc8, 0x20, 0xff, 0x28, 0xb1, 0xd5, 0xef, 0x5d, 0xe2, 0xb0 };
   u8    C3[16] = { 0xdb, 0x92, 0x37, 0x1d, 0x21, 0x26, 0xe9, 0x70, 0x03, 0x24, 0x97, 0x75, 0x04, 0xe8, 0xc9, 0x0e };
   u8    KL[16], KR[16], W0[16], W1[16], W2[16], W3[16];
   u8    out[16];
   int i;
   //KL RoundKey Left
   KL[ 0] = MK[ 0]; KL[ 1] = MK[ 1]; KL[ 2] = MK[ 2]; KL[ 3] = MK[ 3];
   KL[ 4] = MK[ 4]; KL[ 5] = MK[ 5]; KL[ 6] = MK[ 6]; KL[ 7] = MK[ 7];
   KL[ 8] = MK[ 8]; KL[ 9] = MK[ 9]; KL[10] = MK[10]; KL[11] = MK[11];
   KL[12] = MK[12]; KL[13] = MK[13]; KL[14] = MK[14]; KL[15] = MK[15];
   //KR RoundKey Right
   KR[ 0] = MK[16]; KR[ 1] = MK[17]; KR[ 2] = MK[18]; KR[ 3] = MK[19];
   KR[ 4] = MK[20]; KR[ 5] = MK[21]; KR[ 6] = MK[22]; KR[ 7] = MK[23];
   KR[ 8] = MK[24]; KR[ 9] = MK[25]; KR[10] = MK[26]; KR[11] = MK[27];
   KR[12] = MK[28]; KR[13] = MK[29]; KR[14] = MK[30]; KR[15] = MK[31];
   //W0
   W0[ 0] = KL[ 0] ^ M3; W0[ 1] = KL[ 1] ^ M3; W0[ 2] = KL[ 2] ^ M3; W0[ 3] = KL[ 3] ^ M3;
   W0[ 4] = KL[ 4] ^ M3; W0[ 5] = KL[ 5] ^ M3; W0[ 6] = KL[ 6] ^ M3; W0[ 7] = KL[ 7] ^ M3;
   W0[ 8] = KL[ 8] ^ M3; W0[ 9] = KL[ 9] ^ M3; W0[10] = KL[10] ^ M3; W0[11] = KL[11] ^ M3;
   W0[12] = KL[12] ^ M3; W0[13] = KL[13] ^ M3; W0[14] = KL[14] ^ M3; W0[15] = KL[15] ^ M3;
   //W1
   out[ 0] = W0[ 0] ^ M2; out[ 1] = W0[ 1] ^ M2; out[ 2] = W0[ 2] ^ M1; out[ 3] = W0[ 3] ^ M1;
   out[ 4] = W0[ 4] ^ M2; out[ 5] = W0[ 5] ^ M2; out[ 6] = W0[ 6] ^ M1; out[ 7] = W0[ 7] ^ M1;
   out[ 8] = W0[ 8] ^ M2; out[ 9] = W0[ 9] ^ M2; out[10] = W0[10] ^ M1; out[11] = W0[11] ^ M1;
   out[12] = W0[12] ^ M2; out[13] = W0[13] ^ M2; out[14] = W0[14] ^ M1; out[15] = W0[15] ^ M1;

   ENC_ODD(out, C1, W1);
   
   W1[ 0] ^= (KR[ 0] ^ M2); W1[ 1] ^= (KR[ 1] ^ M2); W1[ 2] ^= (KR[ 2] ^ M1); W1[ 3] ^= (KR[ 3] ^ M1);
   W1[ 4] ^= (KR[ 4] ^ M1); W1[ 5] ^= (KR[ 5] ^ M1); W1[ 6] ^= (KR[ 6] ^ M2); W1[ 7] ^= (KR[ 7] ^ M2);
   W1[ 8] ^= (KR[ 8] ^ M2); W1[ 9] ^= (KR[ 9] ^ M2); W1[10] ^= (KR[10] ^ M1); W1[11] ^= (KR[11] ^ M1);
   W1[12] ^= (KR[12] ^ M1); W1[13] ^= (KR[13] ^ M1); W1[14] ^= (KR[14] ^ M2); W1[15] ^= (KR[15] ^ M2);
   //W2
   out[ 0] = W1[ 0] ^ M1; out[ 1] = W1[ 1] ^ M1; out[ 2] = W1[ 2] ^ M2; out[ 3] = W1[ 3] ^ M2;
   out[ 4] = W1[ 4] ^ M1; out[ 5] = W1[ 5] ^ M1; out[ 6] = W1[ 6] ^ M2; out[ 7] = W1[ 7] ^ M2;
   out[ 8] = W1[ 8] ^ M1; out[ 9] = W1[ 9] ^ M1; out[10] = W1[10] ^ M2; out[11] = W1[11] ^ M2;
   out[12] = W1[12] ^ M1; out[13] = W1[13] ^ M1; out[14] = W1[14] ^ M2; out[15] = W1[15] ^ M2;

   ENC_EVEN(out, C2, W2);

   W2[ 0] ^= (W0[ 0] ^ M2); W2[ 1] ^= (W0[ 1] ^ M2); W2[ 2] ^= (W0[ 2] ^ M1); W2[ 3] ^= (W0[ 3] ^ M1);
   W2[ 4] ^= (W0[ 4] ^ M1); W2[ 5] ^= (W0[ 5] ^ M1); W2[ 6] ^= (W0[ 6] ^ M2); W2[ 7] ^= (W0[ 7] ^ M2);
   W2[ 8] ^= (W0[ 8] ^ M2); W2[ 9] ^= (W0[ 9] ^ M2); W2[10] ^= (W0[10] ^ M1); W2[11] ^= (W0[11] ^ M1);
   W2[12] ^= (W0[12] ^ M1); W2[13] ^= (W0[13] ^ M1); W2[14] ^= (W0[14] ^ M2); W2[15] ^= (W0[15] ^ M2);
   //W3
   out[ 0] = W2[ 0] ^ M2; out[ 1] = W2[ 1] ^ M2; out[ 2] = W2[ 2] ^ M1; out[ 3] = W2[ 3] ^ M1;
   out[ 4] = W2[ 4] ^ M2; out[ 5] = W2[ 5] ^ M2; out[ 6] = W2[ 6] ^ M1; out[ 7] = W2[ 7] ^ M1;
   out[ 8] = W2[ 8] ^ M2; out[ 9] = W2[ 9] ^ M2; out[10] = W2[10] ^ M1; out[11] = W2[11] ^ M1;
   out[12] = W2[12] ^ M2; out[13] = W2[13] ^ M2; out[14] = W2[14] ^ M1; out[15] = W2[15] ^ M1;
   
   ENC_ODD(out, C3, W3);

   W3[ 0] ^= (W1[ 0] ^ M1); W3[ 1] ^= (W1[ 1] ^ M1); W3[ 2] ^= (W1[ 2] ^ M2); W3[ 3] ^= (W1[ 3] ^ M2);
   W3[ 4] ^= (W1[ 4] ^ M2); W3[ 5] ^= (W1[ 5] ^ M2); W3[ 6] ^= (W1[ 6] ^ M1); W3[ 7] ^= (W1[ 7] ^ M1);
   W3[ 8] ^= (W1[ 8] ^ M1); W3[ 9] ^= (W1[ 9] ^ M1); W3[10] ^= (W1[10] ^ M2); W3[11] ^= (W1[11] ^ M2);
   W3[12] ^= (W1[12] ^ M2); W3[13] ^= (W1[13] ^ M2); W3[14] ^= (W1[14] ^ M1); W3[15] ^= (W1[15] ^ M1);
   
   ENC_RoundKey(W0, W1, W2, W3, M3);
}
// 4, 6) 입출력 16바이트를 마스킹한다. IN : plaintext, OUT : OUTPUT, M1 : m, M2 : m'
void XOR16(u8 *in, u8 *out, u8 M1, u8 M2) { 
   out[ 0] = in[ 0] ^ M2; out[ 1] = in[ 1] ^ M2; out[ 2] = in[ 2] ^ M1; out[ 3] = in[ 3] ^ M1;
   out[ 4] = in[ 4] ^ M2; out[ 5] = in[ 5] ^ M2; out[ 6] = in[ 6] ^ M1; out[ 7] = in[ 7] ^ M1;
   out[ 8] = in[ 8] ^ M2; out[ 9] = in[ 9] ^ M2; out[10] = in[10] ^ M1; out[11] = in[11] ^ M1;
   out[12] = in[12] ^ M2; out[13] = in[13] ^ M2; out[14] = in[14] ^ M1; out[15] = in[15] ^ M1;
}
// 5) 각 라운드에서 확산 계층 연산 후 16바이트 중간 값중 8바이트를 XOR 연산한다. in : PT중간값, out : output, M3 : MASK
void XOR8(u8* in, u8* out, u8 M3) { 
   out[ 0] = in[ 0]; out[ 1] = in[ 1]; out[ 2] = in[ 2]; out[ 3] = in[ 3];                   
   out[ 4] = in[ 4] ^ M3; out[ 5] = in[ 5] ^ M3; out[ 6] = in[ 6] ^ M3; out[ 7] = in[ 7] ^ M3; 
   out[ 8] = in[ 8]; out[ 9] = in[ 9]; out[10] = in[10]; out[11] = in[11];                    
   out[12] = in[12] ^ M3; out[13] = in[13] ^ M3; out[14] = in[14] ^ M3; out[15] = in[15] ^ M3;
}
// 암호화
void Encryption(u8* PT, u8* CT, u8 M1, u8 M2, u8 M3) {

   u8 out[16];
   XOR16(PT, out, M1, M2);

   ENC_ODD(out, ek1, PT);
   XOR8(PT, out, M3);

   ENC_EVEN(out, ek2, PT);
   XOR8(PT, out, M3);

   ENC_ODD(out, ek3, PT);
   XOR8(PT, out, M3);

   ENC_EVEN(out, ek4, PT);
   XOR8(PT, out, M3);

   ENC_ODD(out, ek5, PT);
   XOR8(PT, out, M3);

   ENC_EVEN(out, ek6, PT);
   XOR8(PT, out, M3);

   ENC_ODD(out, ek7, PT);
   XOR8(PT, out, M3);

   ENC_EVEN(out, ek8, PT);
   XOR8(PT, out, M3);

   ENC_ODD(out, ek9, PT);
   XOR8(PT, out, M3);

   ENC_EVEN(out, ek10, PT);
   XOR8(PT, out, M3);

   ENC_ODD(out, ek11, PT);
   XOR8(PT, out, M3);

   ENC_FINAL(out, ek12, ek13, PT);
   XOR16(PT, CT, M1, M2);
}

#if SS_VER == SS_VER_2_0
uint8_t get_pt(uint8_t cmd, uint8_t scmd, uint8_t len, uint8_t* pt)
#else
uint8_t get_pt(uint8_t* pt, uint8_t len)
#endif

{
    u8 CT[16] = { 0x00 };
    u8 MK[32] = { 0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88, 0x99, 0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff };
    u8 M1, M2, M3; // 마스크 레이어

   //난수 생성
    M1 = rand();
    M2 = rand();
    M3 = M1 ^ M2;

   // 마스크 SBOX 생성
   for(int i = 0; i < 256; i++) 
   {
      int a = i ^ M1;
      int b = SBOX1[i] ^ M2;
      int c = SBOX2[i] ^ M2;

      MSBOX1[a] = b;
      MSBOX2[a] = c;
      MSBOX3[b] = a;
      MSBOX4[c] = a;
   }
	/**********************************
	* Start user-specific code here. */
	trigger_high();
    

   Key_Expansion(MK, M1, M2, M3);
   Encryption(pt, CT, M1, M2, M3);

	//16 hex bytes held in 'pt' were sent
	//from the computer. Store your response
	//back into 'pt', which will send 16 bytes
	//back to computer. Can ignore of course if
	//not needed

	trigger_low();
	/* End user-specific code here. *
	********************************/
	simpleserial_put('r', 16, pt);
	return 0x00;
}

uint8_t reset(uint8_t* x, uint8_t len)
{
	// Reset key here if needed
	return 0x00;
}


int main(void)
{
    platform_init();
	init_uart();
	trigger_setup();

 	/* Uncomment this to get a HELLO message for debug */
	/*
	putch('h');
	putch('e');
	putch('l');
	putch('l');
	putch('o');
	putch('\n');
	*/

	simpleserial_init();
	simpleserial_addcmd('p', 16, get_pt);
#if SS_VER != SS_VER_2_0
	simpleserial_addcmd('k', 16, get_key);
	simpleserial_addcmd('x', 0, reset);
#endif
	while(1)
		simpleserial_get();
}
